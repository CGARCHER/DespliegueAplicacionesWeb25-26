# Migraci√≥n a Autenticaci√≥n SSH - Proyecto SFTP

Este documento explica c√≥mo adaptar el proyecto SFTP para usar autenticaci√≥n con claves SSH en lugar de usuario y contrase√±a.

---

## üîß Cambios necesarios para migrar a SSH

### Resumen de modificaciones
| Componente             | Cambio Necesario                                |
|------------------------|------------------------------------------------|
| **Claves SSH**         | Generar par de claves (privada + p√∫blica)      |
| **docker-compose.yml** | Montar clave p√∫blica, eliminar password del comando |
| **application.properties** | Cambiar `sftp.password` por `sftp.private-key-path` |
| **SftpConfig.java**    | Cambiar propiedad `password` por `privateKeyPath` |
| **SftpService.java**   | Usar `jsch.addIdentity()` en vez de `session.setPassword()` |
| **.gitignore**         | A√±adir clave privada para no subirla a Git     |

---

## üîê Flujo Completo: Aplicaci√≥n Spring Boot y Servidor SFTP

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Aplicaci√≥n  ‚îÇ       ‚îÇ  Servidor    ‚îÇ
‚îÇ Spring Boot  ‚îÇ       ‚îÇ     SFTP     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                      ‚îÇ
       ‚îÇ 1. Crear sesi√≥n SSH  ‚îÇ
       ‚îÇ    con clave privada ‚îÇ
       ‚îÇ jsch.addIdentity()   ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 2. Solicitar conexi√≥n‚îÇ
       ‚îÇ    al servidor SFTP  ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 3. Desaf√≠o + Firma   ‚îÇ
       ‚îÇ    (autenticaci√≥n)   ‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 4. Abrir canal SFTP  ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 5. Cambiar a         ‚îÇ
       ‚îÇ    directorio remoto ‚îÇ
       ‚îÇ    (/uploads)        ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 6. Subir archivo     ‚îÇ
       ‚îÇ    al directorio     ‚îÇ
       ‚îÇ    remoto            ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                      ‚îÇ
       ‚îÇ 7. Confirmar el      ‚îÇ
       ‚îÇ    archivo subido    ‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
       ‚îÇ                      ‚îÇ
       ‚îÇ 8. Cerrar canal y    ‚îÇ
       ‚îÇ    sesi√≥n SSH        ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚ñº                      ‚ñº
```

---

## üîë Paso 1: Generar claves SSH

**Crear directorio para las claves:**
```bash
mkdir ssh-keys
```

**Generar par de claves en formato PEM:**
```bash
ssh-keygen -t rsa -b 4096 -m PEM -f ssh-keys/sftp_key
```

### Explicaci√≥n del comando:
- `-t rsa`: Generar clave con algoritmo RSA (compatible con JSch).
- `-b 4096`: Tama√±o recomendado de clave (4096 bits).
- `-m PEM`: Generar clave en formato PEM.
- `-f`: Ruta donde se guardar√°n las claves.

**Nota:** Cuando se solicite passphrase, simplemente presiona Enter sin ingresar ninguna contrase√±a.

**Comprobaciones:**
- Verificar la clave privada:
  ```bash
  head -n 1 ssh-keys/sftp_key
  ```
  Debe mostrar: `-----BEGIN RSA PRIVATE KEY-----`

- Verificar la clave p√∫blica:
  ```bash
  cat ssh-keys/sftp_key.pub
  ```
  Debe comenzar con: `ssh-rsa AAAAB3NzaC1yc2EA...`

**Archivos generados:**
- `sftp_key` ‚Üí Clave **privada** (üîí no compartir ni subir a Git).
- `sftp_key.pub` ‚Üí Clave **p√∫blica** (a instalar en el servidor).

---

## üê≥ Paso 2: Modificar `docker-compose.yml`

Cambios necesarios:
- Montar la clave p√∫blica en el contenedor.
- Eliminar el password del comando (utilizar `::`).

Archivo: `docker-compose.yml`
```yaml
version: '3.8'

services:
  sftp:
    image: atmoz/sftp:latest
    container_name: sftp-server
    ports:
      - "2222:22"
    volumes:
      # ‚≠ê NUEVO: Montar clave p√∫blica para autenticaci√≥n
      - ./ssh-keys/sftp_key.pub:/home/sftpuser/.ssh/keys/sftp_key.pub:ro
      # Directorio para archivos subidos
      - ./sftp-data:/home/sftpuser/uploads
    # ‚≠ê CAMBIO: Password vac√≠o (::) indica autenticaci√≥n solo SSH
    command: sftpuser::1001:1001

  # Navegador de archivos web (opcional)
  filebrowser:
    image: filebrowser/filebrowser
    container_name: sftp-filebrowser
    ports:
      - "8090:80"
    volumes:
      - ./sftp-data:/srv
    environment:
      - FB_NOAUTH=true
```

---

‚öôÔ∏è Paso 3: Modificar application.properties
Cambios necesarios:
- Eliminar `sftp.password`.
- A√±adir `sftp.private-key-path`.

Archivo: `src/main/resources/application.properties`
```properties
# Configuraci√≥n servidor
server.port=8080

# Configuraci√≥n SFTP con autenticaci√≥n SSH
sftp.host=localhost
sftp.port=2222
sftp.user=sftpuser
sftp.private-key-path=ssh-keys/sftp_key  # ‚≠ê NUEVO
sftp.remote-directory=/uploads

# ‚ö†Ô∏è ELIMINAR esta l√≠nea:
# sftp.password=mipassword
```

---

üíª Paso 4: Modificar SftpConfig.java
Cambios necesarios:
- Cambiar la propiedad `password` por `privateKeyPath`.
- Actualizar los getters y setters correspondientes.

Archivo: `src/main/java/es/hellin/stfp_app/config/SftpConfig.java`
```java
... (El c√≥digo Java permanece igual a la versi√≥n anterior que ya presentamos) ...
```

---

üíª Paso 5: Modificar SftpService.java
Cambios necesarios:
- Usar `jsch.addIdentity()` para cargar la clave privada.
- Eliminar `session.setPassword()`.

Archivo: `src/main/java/es/hellin/stfp_app/service/SftpService.java`
```java
... (El c√≥digo Java permanece igual a la versi√≥n anterior ya presentado) ...
```

---

üìÅ Paso 6: Actualizar .gitignore
Es fundamental **no subir claves privadas al repositorio Git**.

Archivo: `.gitignore`
```gitignore
# Claves privadas SSH - NUNCA SUBIR A GIT
ssh-keys/sftp_key
ssh-keys/*_key
*.pem
id_rsa
id_rsa.*

# Datos temporales
sftp-data/
uploads/

# Build
target/
*.class
*.jar
*.war

# IDE
.idea/
*.iml
.vscode/

# Logs
*.log
logs/
```

---

Este archivo incluye el contenido previamente aprobado junto con los pasos 3 a 6 que ayudan a completar el proceso. Av√≠same si necesitas alg√∫n detalle adicional.